# χ²-DFD 深度伪造检测系统 · 本地运行指南

> 本指南面向需要离线复现 MFA 模块的开发者，覆盖环境部署、数据准备、抽帧裁脸及 LLaVA 推理全流程。

## 1️⃣ 环境要求
- 操作系统：Windows 10/11、Linux 或 macOS（建议具备 NVIDIA GPU）
- Python：3.10（建议使用 venv）
- 显卡：≥8 GB 显存（RTX 30 系列实测可跑 4bit 量化模型）
- 工具链：Visual C++ Build Tools（Windows）或等效编译环境

## 2️⃣ 安装步骤
```
python -m venv deepfake_env
# Windows
deepfake_env\Scripts\activate
# Linux/macOS
source deepfake_env/bin/activate

pip install -r requirements.txt
pip install insightface onnxruntime-gpu
```
> 首次安装 `insightface` 需要完整的 C++ 构建工具，若报错请先安装 Visual Studio Build Tools。

## 3️⃣ 模型与数据准备
1. **LLaVA 权重**：下载 `llava-hf/llava-1.5-7b-hf` 到 `models/llava-1.5-7b-hf/`（可执行 `python scripts/download_llava_cpu.py`）。
2. **FF++ 数据集**：解压 c23 版本到 `data/ffpp_c23/`，保持 `original`、`Deepfakes`、`Face2Face`、`FaceSwap`、`NeuralTextures` 等目录。
3. **（可选）Celeb-DF v2**：放置在 `data/celeb_df_v2/`。
4. `.gitignore` 已忽略大文件目录，避免误提交。

## 4️⃣ 数据划分
```
python code/mfa_metadata.py
```
生成 `metadata/ffpp_c23_split.json`（train=4000、val=500、test=500）及 CSV 版本。

## 5️⃣ 抽帧与裁脸
```
python code/extract_ffpp_frames.py --split train
python code/extract_ffpp_frames.py --split val
python code/extract_ffpp_frames.py --split test
# 额外伪造方法（FaceShifter / DeepFakeDetection）
python code/extract_ffpp_frames.py --split extra --include-extra
```
- 使用 InsightFace（RetinaFace + SCRFD）以 2 FPS 抽取 ≤16 帧，并裁剪 224×224 的人脸。
- 输出位于 `data/processed/ffpp_c23/faces_224/` 与 `raw_frames/`。
- 每 20 条视频打印一次进度，可随时中断并重跑覆盖。

## 6️⃣ MFA 批量推理
```
python code/run_mfa_ffpp.py --split val  --model-dir models/llava-1.5-7b-hf --quant 4bit --progress-interval 20
python code/run_mfa_ffpp.py --split test --model-dir models/llava-1.5-7b-hf --quant 4bit --progress-interval 20
```
- 默认使用 4bit (nf4) 量化加载 LLaVA-1.5-7B。
- 每个视频完成后追加到 `metadata/mfa_ffpp_<split>_progress.jsonl`。
- 终端每 `--progress-interval` 个新视频打印累计进度；`Ctrl+C` 中断后重复执行即可续跑。

## 7️⃣ 查看结果
- `metadata/mfa_ffpp_val.json` / `metadata/mfa_ffpp_test.json`：统计 Balanced Accuracy、TP/TN/FP/FN。
- `metadata/mfa_feature_rankings.json`：Top-K 问题及平均 BA。
- `metadata/mfa_ffpp_*_progress.jsonl`：逐视频投票详情，便于排查误判。

## 8️⃣ 常见问题
| 问题 | 排查方法 |
|------|----------|
| `insightface` 编译失败 | 安装 Visual Studio Build Tools，确认 `cl.exe` 可用，再执行 `pip install insightface onnxruntime-gpu` |
| LLaVA 加载慢 | 首次量化加载约 30~40 s，之后推理耗时较长，建议保持命令运行 |
| 运行时间过长 | 可通过 `--frames-per-video` 或删减问题列表控制计算量 |
| 误提交大文件 | 推送前执行 `git status`，确保 `data/ffpp_c23`、`data/celeb_df_v2`、`data/processed` 未被跟踪 |

## 9️⃣ 下一步
- 基于 Top-K 问题训练轻量级检测器或可解释性可视化。
- 扩展到 Celeb-DF、DFDC 等跨库评估。
- 将阶段成果同步至 GitHub，便于备份与分享（详见 `deploy_to_github.md`）。
